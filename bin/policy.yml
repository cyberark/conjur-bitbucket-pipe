---
- !policy
  id: conjur/authn-jwt/bitbucket
  body:
    - !webservice
    - !variable provider-uri
    - !variable token-app-property # This can be "pipelineUuid", "stepUuid", or one of the other claims provided in the Bitbucket JWT
    - !variable identity-path # This can be "conjur/authn-jwt/bitbucket/pipelines"
    
    - !group authenticatable
    - !permit
      role: !group authenticatable
      privilege: [ read, authenticate ]
      resource: !webservice

# Create a policy to contain any Bitbucket pipelines
- !policy
  id: bitbucket-pipelines
  body:
    - !group

    - &hosts
      - !host
        id: "{7c459824-f46b-48dc-9f29-e23b6f8a2655}"
        annotations:
          authn-jwt/bitbucket/repositoryUuid: "{7c459824-f46b-48dc-9f29-e23b6f8a2655}"

    - !grant
      role: !group
      members: *hosts

    # Create some secrets for the pipelines to use
    - &variables
      - !variable secret1
      - !variable secret2
      - !variable myvar
    
    # Allow the pipelines to read the variables
    - !permit
      role: !group
      privilege: [ read, execute ]
      resource: *variables

# Add the pipelines to the group that can authenticate using authn-jwt/bitbucket
- !grant
  role: !group conjur/authn-jwt/bitbucket/authenticatable
  members: !group bitbucket-pipelines
