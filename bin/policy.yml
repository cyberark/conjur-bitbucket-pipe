# Setup authn for Bitbucket
- !policy
  id: conjur/authn-bitbucket/ci
  body:
    - !webservice
    
    - !variable server-url
    - !variable workspace-uuid
    - !variable identity-path
    
    - !group authenticatable
    - !permit
      role: !group authenticatable
      privilege: [ read, authenticate ]
      resource: !webservice

# Create a policy to contain any Bitbucket pipelines
- !policy
  id: bitbucket-pipelines
  body:
    - !group

    - &hosts
      - !host 7c459824-f46b-48dc-9f29-e23b6f8a2655 # This is the repositoryUuid
    
    - !grant
      role: !group
      members: *hosts

    # Create some secrets for the pipelines to use
    - &variables
      - !variable secret1
      - !variable secret2
      - !variable myvar
    
    # Allow the pipelines to read the variables
    - !permit
      role: !group
      privilege: [ read, execute ]
      resource: *variables

# Add the pipelines to the group that can authenticate using authn-bitbucket/ci
- !grant
  role: !group conjur/authn-bitbucket/ci/authenticatable
  members: !group bitbucket-pipelines
