image:
  name: atlassian/default-image:4

pipelines:
  default:
    - step:
        name: 'Test pipe'
        oidc: true
        script:
          - cd bin
          - ./start-conjur.sh
          - pipe: docker://cyberark/conjur-bitbucket-pipe:edge
            variables:
              CONJUR_URL: 'http://$BITBUCKET_DOCKER_HOST_INTERNAL:8888'
              CONJUR_ACCOUNT: 'conjur'
              CONJUR_SERVICE_ID: 'ci'
              SECRETS: 'conjur/authn-bitbucket/ci/pipelines/secret1,conjur/authn-bitbucket/ci/pipelines/secret2'
        after-script:
          - docker-compose logs
        services:
          - docker
    - step:
        name: 'Load secrets'
        script:
          - find $BITBUCKET_PIPE_SHARED_STORAGE_DIR
          - $BITBUCKET_PIPE_SHARED_STORAGE_DIR/cyberark/conjur-bitbucket-pipe/load_secrets.sh
          - env | grep secret
          - find $BITBUCKET_PIPE_SHARED_STORAGE_DIR
