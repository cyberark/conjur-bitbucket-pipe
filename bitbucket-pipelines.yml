image:
  name: atlassian/default-image:4

pipelines:
  default:
    - step:
        name: 'Test pipe'
        oidc: true
        script:
          - cd bin
          - ./start-conjur.sh
          - pipe: docker://cyberark/conjur-bitbucket-pipe:edge
            variables:
              CONJUR_URL: 'http://$BITBUCKET_DOCKER_HOST_INTERNAL:8888'
              CONJUR_ACCOUNT: 'conjur'
              CONJUR_SERVICE_ID: 'bitbucket'
              SECRETS: 'bitbucket-pipelines/secret1,bitbucket-pipelines/secret2,bitbucket-pipelines/myvar'
              
        after-script:
          - docker-compose logs
        services:
          - docker
    - step:
        name: 'Load secrets'
        script:
          - . /opt/atlassian/pipelines/agent/build/.bitbucket/pipelines/generated/pipeline/pipes/cyberark/conjur-bitbucket-pipe/load_secrets.sh
          - echo "secret1=$secret1"
          - echo "secret2=$secret2"
          - echo "myvar=$myvar"
